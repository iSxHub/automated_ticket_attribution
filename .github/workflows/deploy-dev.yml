name: deploy-dev

on:
  push:
    tags:
      - "*-dev"

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-dev
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      PYTHONHASHSEED: "0"

      # define TAG once for the whole job (this workflow runs only on tags)
      TAG: ${{ github.ref_name }}

      # expose AWS deployment inputs once for reuse across steps
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
      ECR_REPO: ${{ vars.ECR_REPO }}
      DEPLOY_BUCKET: ${{ vars.DEPLOY_BUCKET }}
      DEV_EC2_INSTANCE_ID: ${{ vars.DEV_EC2_INSTANCE_ID }}

      # default once here; empty/undefined vars.SSM_PATH becomes /atta/dev
      SSM_PATH: ${{ vars.SSM_PATH || '/atta/dev' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Ensure tag commit is on dev branch
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin dev --prune

          TAG_COMMIT="$(git rev-parse HEAD)"
          echo "[guard] tag=${TAG} commit=${TAG_COMMIT}"
          echo "[guard] verifying commit is contained in origin/dev..."

          if ! git merge-base --is-ancestor "${TAG_COMMIT}" "origin/dev"; then
            echo "::error::Tag ${TAG} points to ${TAG_COMMIT}, which is NOT on origin/dev. Create the tag from dev." >&2
            exit 1
          fi

      - name: Setup Python + deps
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: "3.10"

      # centralized CI + artifacts
      - name: Quality gates + reports
        uses: ./.github/actions/ci-quality
        with:
          artifact-name: test-reports

      - name: Log deploy context
        shell: bash
        run: |
          set -euo pipefail
          echo "[deploy] tag=${TAG}"
          echo "[deploy] region=${AWS_REGION}"
          echo "[deploy] ecr_repo=${ECR_REPO}"
          echo "[deploy] bucket=${DEPLOY_BUCKET}"
          echo "[deploy] instance=${DEV_EC2_INSTANCE_ID}"
          # NEW: already defaulted at job env
          echo "[deploy] ssm_path=${SSM_PATH}"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build & push Docker image to ECR
        shell: bash
        run: |
          set -euo pipefail

          # assert TAG exists (prevents unbound var explosions)
          : "${TAG:?Missing TAG}"
          : "${AWS_ACCOUNT_ID:?Missing env AWS_ACCOUNT_ID}"
          : "${ECR_REPO:?Missing env ECR_REPO}"
          : "${AWS_REGION:?Missing env AWS_REGION}"

          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPO}:${TAG}"

          echo "[ecr] registry=${ECR_REGISTRY}"
          echo "[ecr] repo=${ECR_REPO}"
          echo "[ecr] image_uri=${IMAGE_URI}"

          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${ECR_REGISTRY}"

          docker build -t "${IMAGE_URI}" .
          docker push "${IMAGE_URI}"

          echo "IMAGE_URI=${IMAGE_URI}" >> "$GITHUB_ENV"

      - name: Package source (deploy bundle)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x deploy/build_bundle.sh
          deploy/build_bundle.sh "${TAG}"

      - name: Upload deploy bundle artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: deploy-bundle-${{ github.ref_name }}
          # include checksum artifact too
          path: |
            atta-${{ github.ref_name }}.tar.gz
            atta-${{ github.ref_name }}.tar.gz.sha256
          if-no-files-found: error
          retention-days: 7

      - name: Upload artifact to S3
        shell: bash
        run: |
          set -euo pipefail
          : "${TAG:?Missing TAG}"
          : "${AWS_REGION:?Missing vars.AWS_REGION}"
          : "${DEPLOY_BUCKET:?Missing vars.DEPLOY_BUCKET}"

          BUCKET="${DEPLOY_BUCKET}"

          echo "[s3] uploading bundle to s3://${BUCKET}/atta/${TAG}/atta-${TAG}.tar.gz"
          aws --region "${AWS_REGION}" s3 cp \
            "atta-${TAG}.tar.gz" \
            "s3://${BUCKET}/atta/${TAG}/atta-${TAG}.tar.gz"

          # upload checksum next to the bundle
          echo "[s3] uploading checksum to s3://${BUCKET}/atta/${TAG}/atta-${TAG}.tar.gz.sha256"
          aws --region "${AWS_REGION}" s3 cp \
            "atta-${TAG}.tar.gz.sha256" \
            "s3://${BUCKET}/atta/${TAG}/atta-${TAG}.tar.gz.sha256"

      - name: Deploy on EC2 via SSM Run Command
        shell: bash
        run: |
          set -euo pipefail

          chmod +x deploy/ssm_deploy.sh

          export TAG="${TAG}"
          export INSTANCE_ID="${DEV_EC2_INSTANCE_ID}"
          export AWS_REGION="${AWS_REGION}"
          export BUCKET="${DEPLOY_BUCKET}"

          # Read from env populated in ECR step
          export ATTA_IMAGE="${IMAGE_URI}"

          # SSM_PATH already defaulted at job env level (no duplication here)
          export SSM_PATH="${SSM_PATH}"

          : "${INSTANCE_ID:?Missing vars.DEV_EC2_INSTANCE_ID}"
          : "${AWS_REGION:?Missing vars.AWS_REGION}"
          : "${ATTA_IMAGE:?Missing IMAGE_URI env (Build step failed?)}"
          : "${BUCKET:?Missing vars.DEPLOY_BUCKET}"

          deploy/ssm_deploy.sh